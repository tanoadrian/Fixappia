<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <title>FixappIA - Login y Consultas</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";const firebaseConfig = {
  apiKey: "AIzaSyC0HCxnBj3TXLnDQb7x8HAtV2sTbImNtt0",
  authDomain: "fixappia.firebaseapp.com",
  projectId: "fixappia",
  storageBucket: "fixappia.appspot.com",
  messagingSenderId: "XXX",
  appId: "XXX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const statusBox = document.getElementById("status");
const queryButton = document.getElementById("makeQuery");
const countDisplay = document.getElementById("consultaCount");

const consultasMax = 3;

registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("regEmail").value;
  const password = document.getElementById("regPassword").value;
  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "usuarios", userCred.user.uid), {
      consultasHoy: 0,
      lastQueryDate: new Date().toISOString().slice(0, 10),
      plan: "free"
    });
    alert("¡Registro exitoso!");
  } catch (err) {
    alert("Error en registro: " + err.message);
  }
});

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("logEmail").value;
  const password = document.getElementById("logPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    alert("Error en login: " + err.message);
  }
});

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const ref = doc(db, "usuarios", user.uid);
    const snap = await getDoc(ref);
    let data = snap.data();
    const today = new Date().toISOString().slice(0, 10);
    if (data.lastQueryDate !== today) {
      await updateDoc(ref, { consultasHoy: 0, lastQueryDate: today });
      data.consultasHoy = 0;
    }
    countDisplay.textContent = `Te quedan ${consultasMax - data.consultasHoy} consultas gratis hoy.`;
    queryButton.disabled = data.consultasHoy >= consultasMax && data.plan === "free";
    queryButton.textContent = data.plan === "free" ? "Hacer Consulta (Plan Gratuito)" : "Hacer Consulta (Premium)";
    statusBox.textContent = `Estás logueado como ${user.email}. Plan: ${data.plan}`;
  }
});

queryButton.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("Tenés que estar logueado.");
  const ref = doc(db, "usuarios", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();
  if (data.plan === "free" && data.consultasHoy >= consultasMax) {
    alert("Límite de consultas alcanzado. Actualizá tu plan.");
    return;
  }
  await updateDoc(ref, { consultasHoy: data.consultasHoy + 1 });
  alert("Consulta registrada. La IA responderá pronto.");
  location.reload();
});

  </script>
</head>
<body>
  <h1>FixappIA Login / Registro</h1>  <div>
    <h3>Registrarse</h3>
    <form id="registerForm">
      Email: <input type="email" id="regEmail" required><br>
      Password: <input type="password" id="regPassword" required><br>
      <button type="submit">Registrarse</button>
    </form>
  </div>  <div>
    <h3>Iniciar sesión</h3>
    <form id="loginForm">
      Email: <input type="email" id="logEmail" required><br>
      Password: <input type="password" id="logPassword" required><br>
      <button type="submit">Login</button>
    </form>
  </div>  <p id="status"></p>
  <p id="consultaCount"></p>
  <button id="makeQuery">Hacer consulta</button>
</body>
</html>
